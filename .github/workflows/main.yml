name: Hello World

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build - ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.runner }}

    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: Linux x86_64
            runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            deb_arch: amd64

          - name: Linux aarch64
            runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            deb_arch: arm64

          - name: Linux x86_64 (musl)
            runner: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            deb_arch: amd64

          - name: Linux aarch64 (musl)
            runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl
            deb_arch: arm64

    steps:
      - uses: actions/checkout@v4

      - name: Install packaging tools
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.platform.target }}
          override: true

      - name: Cargo build
        run: cargo build --release --target ${{ matrix.platform.target }}

      - name: Build .deb package
        run: |
          APP=beskar
          VERSION=1.0.${{ github.run_number }}
          ARCH=${{ matrix.platform.deb_arch }}

          BIN=target/${{ matrix.platform.target }}/release/${APP}

          if [ ! -f "$BIN" ]; then
            echo "ERROR: binary not found: $BIN"
            exit 1
          fi

          PKG=${APP}_${VERSION}_${ARCH}

          mkdir -p ${PKG}/DEBIAN
          mkdir -p ${PKG}/usr/local/bin

          install -m 0755 "$BIN" ${PKG}/usr/local/bin/${APP}

          cat > ${PKG}/DEBIAN/control <<EOF
            Package: ${APP}            Version: ${VERSION}
            Section: utils
            Priority: optional
            Architecture: ${ARCH}
            Maintainer: You <you@example.com>
            Description: Beskar Rust CLI
          EOF

          dpkg-deb --build ${PKG}
          dpkg-deb --info ${PKG}.deb
          file ${PKG}.deb

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: beskar-${{ matrix.platform.target }}
          path: "*.deb"

  release:
    runs-on: ubuntu-22.04
    needs: build

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: release-${{ github.run_number }}
          files: dist/**/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
